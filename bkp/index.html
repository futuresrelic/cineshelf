<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineShelf - Physical Media Collection Manager</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json?v=2">
    
    <!-- iOS specific meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CineShelf">
    
    <!-- Icon for iOS -->
    <link rel="apple-touch-icon" href="icon-180.png">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #f5576c, #4facfe, #00f2fe);
    background-size: 400% 400%;
    animation: gradientShift 15s ease infinite;
    min-height: 100vh;
    color: #333;
    max-width: 420px;
    margin: 0 auto;
    overflow-x: hidden;
    position: relative;
}

body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 255, 198, 0.2) 0%, transparent 50%);
    pointer-events: none;
    z-index: -1;
    animation: floatingOrbs 20s ease-in-out infinite;
}

@keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

@keyframes floatingOrbs {
    0%, 100% { transform: translateY(0px) scale(1); }
    33% { transform: translateY(-20px) scale(1.1); }
    66% { transform: translateY(10px) scale(0.9); }
}

.header {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    padding: 1.5rem 1rem;
    text-align: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    position: relative;
    overflow: hidden;
}

.header::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    animation: shimmer 3s infinite;
}

@keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}

.header h1 {
    color: white;
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    text-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
    letter-spacing: -0.5px;
}

.header-logo {
    width: 36px;
    height: 36px;
    object-fit: contain;
    filter: drop-shadow(0 2px 10px rgba(0, 0, 0, 0.3));
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.header p {
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.95rem;
    font-weight: 300;
    letter-spacing: 0.5px;
}

.tabs {
    display: flex;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.tab {
    flex: 1;
    min-width: 70px;
    padding: 1rem 0.5rem;
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    font-size: 0.85rem;
    font-weight: 500;
    white-space: nowrap;
    position: relative;
    overflow: hidden;
}

.tab::before {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    width: 0;
    height: 3px;
    background: linear-gradient(90deg, #fff, #f0f0f0);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    transform: translateX(-50%);
    border-radius: 2px 2px 0 0;
}

.tab:hover {
    color: rgba(255, 255, 255, 0.9);
    background: rgba(255, 255, 255, 0.05);
    transform: translateY(-1px);
}

.tab.active {
    color: white;
    background: rgba(255, 255, 255, 0.15);
    text-shadow: 0 1px 10px rgba(0, 0, 0, 0.3);
}

.tab.active::before {
    width: 80%;
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.6);
}

.tab-content {
    display: none;
    padding: 1.5rem;
    min-height: calc(100vh - 140px);
    animation: fadeIn 0.6s ease-out;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.form-group {
    margin-bottom: 1.5rem;
    position: relative;
}

.form-group label {
    display: block;
    color: rgba(255, 255, 255, 0.95);
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    font-weight: 500;
    letter-spacing: 0.3px;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 1rem 1.2rem;
    border: none;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    font-size: 1rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15), 0 0 0 3px rgba(255, 255, 255, 0.3);
    background: rgba(255, 255, 255, 0.98);
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

.btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    background-size: 200% 200%;
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 14px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    width: 100%;
    margin-bottom: 0.75rem;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    position: relative;
    overflow: hidden;
    letter-spacing: 0.3px;
}

.btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
}

.btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2);
    background-position: 100% 0;
}

.btn:hover::before {
    left: 100%;
}

.btn:active {
    transform: translateY(-1px);
    transition: transform 0.1s;
}

.btn-secondary {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.1) 100%);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.btn-secondary:hover {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.2) 100%);
}

.btn-danger {
    background: linear-gradient(135deg, #ff4757 0%, #ff3838 50%, #ff6b7a 100%);
    background-size: 200% 200%;
}

.btn-danger:hover {
    background-position: 100% 0;
}

.status {
    padding: 1rem 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    display: none;
    font-weight: 500;
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    animation: slideIn 0.5s ease-out;
}

/* FIX: Add the missing .show class */
.status.show {
    display: block !important;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.status.success {
    background: linear-gradient(135deg, rgba(39, 174, 96, 0.25) 0%, rgba(46, 204, 113, 0.15) 100%);
    color: #27ae60;
    border: 1px solid rgba(39, 174, 96, 0.4);
    box-shadow: 0 4px 15px rgba(39, 174, 96, 0.1);
}

.status.error {
    background: linear-gradient(135deg, rgba(231, 76, 60, 0.25) 0%, rgba(255, 107, 107, 0.15) 100%);
    color: #e74c3c;
    border: 1px solid rgba(231, 76, 60, 0.4);
    box-shadow: 0 4px 15px rgba(231, 76, 60, 0.1);
}

.movie-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.movie-grid.detail-view {
    display: flex !important;
    flex-direction: column !important;
    grid-template-columns: none !important;
    gap: 1.5rem;
}

.movie-grid.list-view {
    display: flex !important;
    flex-direction: column !important;
    grid-template-columns: none !important;
    gap: 1rem;
}

.movie-card {
    background: rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 16px;
    padding: 1.25rem;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid rgba(255, 255, 255, 0.25);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    position: relative;
    overflow: hidden;
}

.movie-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
}

.movie-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    border-color: rgba(255, 255, 255, 0.4);
}

.movie-card:hover::before {
    opacity: 1;
}

.movie-card.detail-item {
    display: flex !important;
    padding: 1.5rem;
    gap: 1.5rem;
    align-items: center;
    transform: none;
}

.movie-card.detail-item:hover {
    transform: translateY(-4px);
}

.movie-card.detail-item .movie-poster {
    width: 90px !important;
    height: 135px !important;
    flex-shrink: 0;
    margin-bottom: 0 !important;
}

.movie-card.detail-item .movie-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.movie-card.detail-item .movie-title {
    font-size: 1.1rem !important;
    margin-bottom: 0.5rem;
}

.movie-card.detail-item .movie-info {
    font-size: 0.9rem !important;
}

.movie-card.detail-item .movie-details {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.8rem;
    line-height: 1.5;
}

.movie-card.list-item {
    display: flex !important;
    padding: 1rem !important;
    gap: 1rem;
    align-items: center;
    transform: none;
}

.movie-card.list-item:hover {
    transform: translateY(-2px);
}

.movie-card.list-item .movie-poster {
    width: 50px !important;
    height: 75px !important;
    flex-shrink: 0;
    margin-bottom: 0 !important;
}

.movie-card.list-item .movie-content {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.movie-card.list-item .movie-title {
    font-size: 1rem !important;
    margin-bottom: 0.25rem !important;
    line-height: 1.3;
}

.movie-card.list-item .movie-info {
    font-size: 0.8rem !important;
    opacity: 0.9;
}

.movie-poster {
    width: 100%;
    height: 220px;
    object-fit: cover;
    border-radius: 12px;
    margin-bottom: 0.75rem;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
    transition: transform 0.3s ease;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.movie-poster:hover {
    transform: scale(1.05);
}

.view-controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    gap: 1.5rem;
}

.view-toggle {
    display: flex;
    background: rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-radius: 12px;
    padding: 0.4rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.view-btn {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    padding: 0.6rem 0.8rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-size: 1rem;
    font-weight: 500;
}

.view-btn:hover {
    color: rgba(255, 255, 255, 0.9);
    background: rgba(255, 255, 255, 0.1);
}

.view-btn.active {
    background: rgba(255, 255, 255, 0.25);
    color: white;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
}

.resolve-next-section {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 100%);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    padding: 1.5rem;
    border-radius: 16px;
    margin-bottom: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.25);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.resolve-next-info {
    color: rgba(255, 255, 255, 0.95);
    font-size: 0.95rem;
    margin-bottom: 1rem;
    line-height: 1.6;
}

.resolve-next-title {
    color: white;
    font-weight: 700;
    margin-bottom: 0.75rem;
    font-size: 1.1rem;
    text-shadow: 0 1px 10px rgba(0, 0, 0, 0.3);
}

.movie-title {
    color: white;
    font-size: 0.95rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-shadow: 0 1px 10px rgba(0, 0, 0, 0.4);
}

.movie-info {
    color: rgba(255, 255, 255, 0.85);
    font-size: 0.8rem;
    line-height: 1.4;
    font-weight: 400;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 1000;
    overflow-y: auto;
    animation: modalFadeIn 0.3s ease-out;
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        backdrop-filter: blur(0px);
        -webkit-backdrop-filter: blur(0px);
    }
    to {
        opacity: 1;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
    }
}

.modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    margin: 1.5rem;
    padding: 2rem;
    border-radius: 20px;
    max-width: 400px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.2);
    animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal-close {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.4rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    font-weight: 300;
}

.modal-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.search-results {
    max-height: 450px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
}

.search-results::-webkit-scrollbar {
    width: 6px;
}

.search-results::-webkit-scrollbar-track {
    background: transparent;
}

.search-results::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
}

.search-result {
    display: flex;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    margin-bottom: 0.75rem;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid rgba(255, 255, 255, 0.15);
}

.search-result:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.search-poster {
    width: 70px;
    height: 105px;
    object-fit: cover;
    border-radius: 8px;
    margin-right: 1.5rem;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.search-info {
    flex: 1;
    color: white;
}

.search-title {
    font-weight: 700;
    margin-bottom: 0.5rem;
    font-size: 1rem;
    text-shadow: 0 1px 10px rgba(0, 0, 0, 0.3);
}

.search-details {
    font-size: 0.85rem;
    opacity: 0.9;
    line-height: 1.5;
}

.movie-detail-poster {
    width: 170px;
    height: 255px;
    object-fit: cover;
    border-radius: 16px;
    margin: 0 auto 1.5rem;
    display: block;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
}

.detail-section {
    background: rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.detail-title {
    color: white;
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    text-shadow: 0 1px 10px rgba(0, 0, 0, 0.3);
}

.detail-text {
    color: rgba(255, 255, 255, 0.95);
    font-size: 0.95rem;
    line-height: 1.6;
}

.empty-state {
    text-align: center;
    color: rgba(255, 255, 255, 0.8);
    padding: 4rem 1.5rem;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.empty-state h3 {
    color: white;
    margin-bottom: 0.75rem;
    font-size: 1.3rem;
    font-weight: 700;
    text-shadow: 0 1px 10px rgba(0, 0, 0, 0.3);
}

.file-input {
    display: none;
}

.file-label {
    display: inline-block;
    padding: 1rem 2rem;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    color: white;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    margin-bottom: 0.75rem;
    width: 100%;
    text-align: center;
    font-weight: 600;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.file-label:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.resolve-item {
    background: rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.25);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.resolve-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
}

.resolve-title {
    color: white;
    font-weight: 700;
    margin-bottom: 0.75rem;
    font-size: 1.1rem;
    text-shadow: 0 1px 10px rgba(0, 0, 0, 0.3);
}

.resolve-details {
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.9rem;
    margin-bottom: 1rem;
    line-height: 1.5;
}

.two-column {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

@media (max-width: 390px) {
    .movie-grid {
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 1rem;
    }
    
    .modal-content {
        margin: 1rem;
        padding: 1.5rem;
    }

    .two-column {
        grid-template-columns: 1fr;
    }
    
    .header {
        padding: 1.25rem 1rem;
    }
    
    .header h1 {
        font-size: 1.6rem;
    }
}

.sort-controls {
    background: rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    padding: 1.25rem;
    border-radius: 12px;
    margin-bottom: 1.25rem;
    border: 1px solid rgba(255, 255, 255, 0.25);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.sort-controls .form-group {
    margin-bottom: 0;
}

.sort-controls label {
    font-size: 0.95rem;
    margin-bottom: 0.75rem;
    font-weight: 600;
}

.sort-controls select {
    background: rgba(255, 255, 255, 0.95);
    font-size: 0.95rem;
    border-radius: 10px;
}

.upc-input-group {
    display: flex;
    gap: 0.75rem;
    align-items: flex-end;
}

.upc-input-group input {
    flex: 1;
}

.scan-btn {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 50%, #2f855a 100%);
    background-size: 200% 200%;
    color: white;
    border: none;
    padding: 1rem 1.25rem;
    border-radius: 12px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    white-space: nowrap;
    min-width: 90px;
    box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
}

.scan-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(72, 187, 120, 0.4);
    background-position: 100% 0;
}

.scan-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.scanner-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 2000;
    overflow: hidden;
    animation: modalFadeIn 0.3s ease-out;
}

.scanner-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.scanner-container-modal {
    background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
    margin: 1.5rem;
    padding: 2rem;
    border-radius: 20px;
    max-width: 420px;
    width: 100%;
    max-height: 90vh;
    position: relative;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.scanner-header {
    color: white;
    text-align: center;
    margin-bottom: 1.5rem;
}

.scanner-header h3 {
    margin-bottom: 0.75rem;
    font-size: 1.3rem;
    font-weight: 700;
}

.scanner-hint {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.95rem;
    font-weight: 400;
}

.scanner-viewport {
    position: relative;
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 1.5rem;
    background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
    min-height: 280px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: inset 0 4px 15px rgba(0, 0, 0, 0.3);
}

#barcodeScanner {
    width: 100%;
    height: 280px;
    position: relative;
}

#barcodeScanner canvas,
#barcodeScanner video {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover;
    border-radius: 16px;
}

.scanner-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 220px;
    height: 90px;
    border: 3px solid #48bb78;
    border-radius: 12px;
    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
    pointer-events: none;
}

.scanner-overlay::before {
    content: '';
    position: absolute;
    top: -3px;
    left: -3px;
    right: -3px;
    bottom: -3px;
    border: 3px solid #48bb78;
    border-radius: 12px;
    animation: scannerPulse 2s infinite;
}

@keyframes scannerPulse {
    0% { opacity: 1; box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7); }
    50% { opacity: 0.7; box-shadow: 0 0 0 10px rgba(72, 187, 120, 0); }
    100% { opacity: 1; box-shadow: 0 0 0 0 rgba(72, 187, 120, 0); }
}

.scanner-controls {
    display: flex;
    gap: 0.75rem;
}

.scanner-controls button {
    flex: 1;
    padding: 1rem;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-size: 1rem;
}

.scanner-close {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.scanner-close:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: translateY(-2px);
}

.scanner-placeholder {
    text-align: center;
    color: rgba(255, 255, 255, 0.7);
    padding: 2rem;
}

.scanner-placeholder div {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.8;
}

.api-key-section {
    background: rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    padding: 1.5rem;
    border-radius: 16px;
    margin-bottom: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.25);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.camera-section {
    margin-bottom: 1.5rem;
    text-align: center;
}

.camera-controls {
    margin-bottom: 1.5rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
}

.camera-controls button {
    flex: 1;
    min-width: 90px;
    font-size: 0.85rem;
    padding: 0.8rem;
    border-radius: 10px;
}

#coverVideo {
    width: 100%;
    max-width: 320px;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    display: none;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
}

#coverCanvas {
    display: none;
}

.captured-image {
    max-width: 110px;
    height: 165px;
    object-fit: cover;
    border-radius: 12px;
    margin: 0.5rem;
    cursor: pointer;
    border: 2px solid rgba(255, 255, 255, 0.4);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.captured-image:hover {
    border-color: #667eea;
    transform: scale(1.05) translateY(-4px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.captured-images-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.clear-btn {
    background: linear-gradient(135deg, #fd7e14 0%, #e8630a 50%, #d55200 100%) !important;
    background-size: 200% 200% !important;
}

.clear-btn:hover {
    background-position: 100% 0 !important;
}

.test-btn {
    background: linear-gradient(135deg, #ffc107 0%, #e0a800 50%, #cc9900 100%) !important;
    background-size: 200% 200% !important;
    color: #000 !important;
    font-weight: 700 !important;
}

.test-btn:hover {
    background-position: 100% 0 !important;
}

.loading {
    text-align: center;
    color: white;
    font-weight: 600;
    margin: 1.5rem 0;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    animation: pulse 2s ease-in-out infinite;
}

.titles-section {
    margin-top: 1.5rem;
}

.title-item {
    margin-bottom: 1rem;
    padding: 1.25rem;
    background: rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    border: 1px solid rgba(255, 255, 255, 0.25);
    transition: all 0.3s ease;
}

.title-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.title-item input {
    flex: 1;
    margin-bottom: 0;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 8px;
}

.title-actions {
    display: flex;
    gap: 0.5rem;
}

.title-actions button {
    padding: 0.6rem 0.8rem;
    font-size: 0.85rem;
    min-width: auto;
    width: auto;
    border-radius: 8px;
    font-weight: 600;
}

.use-btn {
    background: linear-gradient(135deg, #28a745 0%, #20c997 50%, #17a2b8 100%) !important;
    background-size: 200% 200% !important;
}

.use-btn:hover {
    background-position: 100% 0 !important;
}

.remove-btn {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 50%, #b21e35 100%) !important;
    background-size: 200% 200% !important;
}

.remove-btn:hover {
    background-position: 100% 0 !important;
}

.action-buttons {
    margin: 1.5rem 0;
    text-align: center;
}

.action-buttons button {
    margin-bottom: 0.75rem;
}

#outputArea {
    width: 100%;
    height: 180px;
    margin: 1.5rem 0;
    padding: 1rem;
    border: 2px solid rgba(255, 255, 255, 0.4);
    border-radius: 12px;
    font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    display: none;
    font-size: 0.9rem;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

#outputArea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1), 0 0 0 3px rgba(102, 126, 234, 0.3);
}

.compact-controls {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
}
    </style>
<!-- Add this to your <head> section before closing </head> tag -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <div class="header">
        <h1>
            <img src="logo.png" alt="CineShelf Logo" class="header-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
            <span style="display: none;">ðŸŽ¬</span>
            CineShelf
        </h1>
        <p style="color: rgba(255,255,255,0.8); font-size: 0.9rem;">Physical Media Collection Manager</p>
    </div>

    <!-- Add this new tab to your tabs section -->
<div class="tabs">
    <button class="tab active" onclick="App.switchTab('scan')">Scan</button>
    <button class="tab" onclick="App.switchTab('covers')">Cover Scan</button>
    <button class="tab" onclick="App.switchTab('collection')">Collection</button>
    <button class="tab" onclick="App.switchTab('wishlist')">Wishlist</button>
    <button class="tab" onclick="App.switchTab('resolve')">Resolve</button>
    <button class="tab" onclick="App.switchTab('social')">Social</button>
    <button class="tab" onclick="App.switchTab('data')">Data</button>
</div>

    <!-- Scan Tab -->
    <div id="scan" class="tab-content active">
        <div id="status" class="status"></div>
        
        <div id="resolveNextSection" class="resolve-next-section" style="display: none;">
            <div class="resolve-next-title">ðŸ” Resolving Unmatched Item</div>
            <div id="resolveNextInfo" class="resolve-next-info"></div>
            <button onclick="App.skipToNextUnresolved()" class="btn btn-secondary">Skip to Next Unresolved</button>
        </div>
        
        <form id="movieForm">
            <div class="form-group">
                <label for="movieTitle">Movie Title *</label>
                <input type="text" id="movieTitle" required>
            </div>

            <button type="button" id="searchBtn" class="btn">
                <span id="searchBtnText">ðŸ” Search Movie Database</span>
                <div id="searchLoader" class="loading" style="display: none;"></div>
            </button>

            <div class="form-group">
                <label for="upc">UPC/Barcode</label>
                <div class="upc-input-group">
                    <input type="text" id="upc">
                    <button type="button" id="scanUpcBtn" class="scan-btn">ðŸ“· Scan</button>
                </div>
            </div>

            <div class="two-column">
                <div class="form-group">
                    <label for="format">Format *</label>
                    <select id="format" required>
                        <option value="">Select Format</option>
                        <option value="DVD">DVD</option>
                        <option value="Blu-ray">Blu-ray</option>
                        <option value="4K">4K Ultra HD</option>
                        <option value="VHS">VHS</option>
                        <option value="Digital">Digital</option>
                        <option value="Laserdisc">Laserdisc</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="region">Region</label>
                    <select id="region">
                        <option value="">Select Region</option>
                        <option value="Region 1">Region 1 (US/Canada)</option>
                        <option value="Region 2">Region 2 (Europe/Japan)</option>
                        <option value="Region 3">Region 3 (Asia)</option>
                        <option value="Region 4">Region 4 (Australia)</option>
                        <option value="Region Free">Region Free</option>
                        <option value="All Regions">All Regions</option>
                    </select>
                </div>
            </div>

            <div class="two-column">
                <div class="form-group">
                    <label for="discs">Number of Discs</label>
                    <input type="number" id="discs" min="1" value="1">
                </div>

                <div class="form-group">
                    <label for="edition">Edition</label>
                    <input type="text" id="edition" placeholder="Standard, Director's Cut, etc.">
                </div>
            </div>

            <div class="form-group">
                <label for="languages">Languages/Subtitles</label>
                <input type="text" id="languages" placeholder="English, Spanish, French">
            </div>

            <div class="form-group">
                <label for="notes">Notes</label>
                <textarea id="notes" placeholder="Additional information..."></textarea>
            </div>

            <div class="two-column">
                <button type="submit" name="collection" class="btn">Add to Collection</button>
                <button type="submit" name="wishlist" class="btn btn-secondary">Add to Wishlist</button>
            </div>
        </form>
    </div>

    <!-- Cover Scan Tab -->
    <div id="covers" class="tab-content">
        <div id="coverStatus" class="status"></div>
        
        <div class="api-key-section">
            <label for="apiKey">OpenAI API Key:</label>
            <input type="password" id="apiKey" placeholder="sk-..." style="margin-bottom: 0.5rem;">
            <button class="test-btn" onclick="CoverScanner.testAPI()">ðŸ”§ Test API Key</button>
        </div>
        
        <div class="camera-section">
            <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">
            <button onclick="document.getElementById('fileInput').click()" class="btn btn-secondary">ðŸ“ Upload Images</button>
            
            <div class="camera-controls">
                <button onclick="CoverScanner.startCamera()">ðŸ“· Start Camera</button>
                <button onclick="CoverScanner.captureImage()" id="captureBtn" disabled>ðŸ“¸ Capture</button>
                <button onclick="CoverScanner.stopCamera()">â¹ï¸ Stop</button>
                <button onclick="CoverScanner.clearImages()" id="clearBtn" class="clear-btn" disabled>ðŸ—‘ï¸ Clear</button>
            </div>
            
            <video id="coverVideo" autoplay></video>
            <canvas id="coverCanvas"></canvas>
            
            <div id="capturedImages" class="captured-images-container"></div>
            
            <button onclick="CoverScanner.analyzeImages()" id="analyzeBtn" class="btn" disabled>ðŸ¤– Extract Titles with AI</button>
        </div>
        
        <div id="coverLoading" class="loading" style="display: none;">
            Analyzing DVD covers with AI... Please wait.
        </div>
        
        <div class="titles-section">
            <h3 style="color: white; margin-bottom: 1rem;">Extracted Movie Titles:</h3>
            <div id="titlesContainer"></div>
            
            <div class="action-buttons">
                <button onclick="CoverScanner.addNewTitle()" class="btn btn-secondary">âž• Add Manual Title</button>
                <button onclick="CoverScanner.showList()" class="btn">ðŸ“„ Show List</button>
            </div>
            
            <textarea id="outputArea" placeholder="Movie titles will appear here..."></textarea>
            
            <div style="text-align: center; margin-top: 0.5rem;">
                <button onclick="CoverScanner.copyText()" class="btn btn-secondary">ðŸ“‹ Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <!-- Collection Tab -->
    <div id="collection" class="tab-content">
        <div class="view-controls">
            <div class="sort-controls" style="flex: 1; margin-bottom: 0;">
                <div class="form-group">
                    <label for="collectionSort">Sort by:</label>
                    <select id="collectionSort" onchange="App.sortMovies('collection', this.value)">
                        <option value="title">Title (A-Z)</option>
                        <option value="title-desc">Title (Z-A)</option>
                        <option value="year">Year (Oldest First)</option>
                        <option value="year-desc">Year (Newest First)</option>
                        <option value="rating">Rating (Lowest First)</option>
                        <option value="rating-desc">Rating (Highest First)</option>
                        <option value="runtime">Runtime (Shortest First)</option>
                        <option value="runtime-desc">Runtime (Longest First)</option>
                        <option value="director">Director (A-Z)</option>
                        <option value="director-desc">Director (Z-A)</option>
                        <option value="genre">Genre (A-Z)</option>
                        <option value="genre-desc">Genre (Z-A)</option>
                        <option value="format">Format (A-Z)</option>
                        <option value="format-desc">Format (Z-A)</option>
                        <option value="added">Date Added (Oldest First)</option>
                        <option value="added-desc">Date Added (Newest First)</option>
                    </select>
                </div>
            </div>
            <div class="view-toggle">
                <button class="view-btn active" onclick="App.setViewMode('collection', 'grid')" title="Grid View">âŠž</button>
                <button class="view-btn" onclick="App.setViewMode('collection', 'detail')" title="Detail Cards">âŠ¡</button>
                <button class="view-btn" onclick="App.setViewMode('collection', 'list')" title="List View">â˜°</button>
            </div>
        </div>
        <div id="collectionGrid" class="movie-grid"></div>
        <div id="collectionEmpty" class="empty-state">
            <h3>No Movies in Collection</h3>
            <p>Start by scanning or adding movies to build your collection!</p>
        </div>
    </div>

    <!-- Wishlist Tab -->
    <div id="wishlist" class="tab-content">
        <div class="view-controls">
            <div class="sort-controls" style="flex: 1; margin-bottom: 0;">
                <div class="form-group">
                    <label for="wishlistSort">Sort by:</label>
                    <select id="wishlistSort" onchange="App.sortMovies('wishlist', this.value)">
                        <option value="title">Title (A-Z)</option>
                        <option value="title-desc">Title (Z-A)</option>
                        <option value="year">Year (Oldest First)</option>
                        <option value="year-desc">Year (Newest First)</option>
                        <option value="rating">Rating (Lowest First)</option>
                        <option value="rating-desc">Rating (Highest First)</option>
                        <option value="runtime">Runtime (Shortest First)</option>
                        <option value="runtime-desc">Runtime (Longest First)</option>
                        <option value="director">Director (A-Z)</option>
                        <option value="director-desc">Director (Z-A)</option>
                        <option value="genre">Genre (A-Z)</option>
                        <option value="genre-desc">Genre (Z-A)</option>
                        <option value="format">Format (A-Z)</option>
                        <option value="format-desc">Format (Z-A)</option>
                        <option value="added">Date Added (Oldest First)</option>
                        <option value="added-desc">Date Added (Newest First)</option>
                    </select>
                </div>
            </div>
            <div class="view-toggle">
                <button class="view-btn active" onclick="App.setViewMode('wishlist', 'grid')" title="Grid View">âŠž</button>
                <button class="view-btn" onclick="App.setViewMode('wishlist', 'detail')" title="Detail Cards">âŠ¡</button>
                <button class="view-btn" onclick="App.setViewMode('wishlist', 'list')" title="List View">â˜°</button>
            </div>
        </div>
        <div id="wishlistGrid" class="movie-grid"></div>
        <div id="wishlistEmpty" class="empty-state">
            <h3>No Movies in Wishlist</h3>
            <p>Add movies you want to buy to your wishlist!</p>
        </div>
    </div>

    <!-- Resolve Tab -->
    <div id="resolve" class="tab-content">
        <div id="resolveList"></div>
        <div id="resolveEmpty" class="empty-state">
            <h3>All Movies Resolved</h3>
            <p>Great! All your movies have complete information.</p>
        </div>
    </div>

    <!-- Data Management Tab -->
    <div id="data" class="tab-content">
        <!-- User Management Section -->
        <div class="detail-section">
            <div class="detail-title">ðŸ‘¥ User Management</div>
            <div class="form-group">
                <label for="currentUser">Current User:</label>
                <select id="currentUser" onchange="App.switchUser(this.value)">
                    <option value="default">Default User</option>
                </select>
            </div>
            <div class="form-group">
                <input type="text" id="newUserName" placeholder="New user name">
                <button onclick="App.addUser()" class="btn btn-secondary">Add User</button>
            </div>
            <button onclick="App.deleteCurrentUser()" class="btn btn-danger">Delete Current User</button>
        </div>

        <!-- Local Data Management -->
        <div class="detail-section">
            <div class="detail-title">ðŸ’¾ Local Data Management</div>
            <div class="form-group">
                <button onclick="App.exportData()" class="btn">ðŸ“¥ Export Collection (CSV)</button>
            </div>

            <div class="form-group">
                <label for="importFile" class="file-label">ðŸ“¤ Import Collection Data</label>
                <input type="file" id="importFile" class="file-input" accept=".csv,.json" onchange="App.importData(event)">
            </div>

            <div class="form-group">
                <button onclick="App.clearAllData()" class="btn btn-danger">ðŸ—‘ï¸ Clear All Data</button>
            </div>
        </div>

        <!-- Server Backup Section -->
        <div class="detail-section">
            <div class="detail-title">â˜ï¸ Server Backup</div>
            <div class="form-group">
                <button onclick="App.backupToServer()" class="btn">ðŸ“¤ Backup to Server</button>
            </div>
            <div class="form-group">
                <button onclick="App.restoreFromServer()" class="btn btn-secondary">ðŸ“¥ Restore from Server</button>
            </div>
            <div id="serverStatus" class="status" style="display: none;"></div>
            <div class="detail-text" style="font-size: 0.8rem; opacity: 0.8; margin-top: 0.5rem;">
                Note: Server backup requires server-side script setup. Data is saved as JSON files on your web server.
            </div>
        </div>

        <div class="detail-section">
            <div class="detail-title">Collection Statistics</div>
            <div id="stats" class="detail-text"></div>
        </div>
    </div>
<!-- Add this new Social tab content after your existing tabs -->
<div id="social" class="tab-content">
    <div id="socialStatus" class="status"></div>
    
    <!-- Google Login Section -->
    <div class="detail-section">
        <div class="detail-title">ðŸ” Account & Cloud Sync</div>
        <div id="googleLoginContainer">
            <div id="signInSection" style="display: none;">
                <p class="detail-text">Sign in with Google to sync your collection across all devices and share with friends.</p>
                <div id="g_id_onload" 
                     data-client_id="754407099284-haohg81b0a00kmru2ad8m7v1av9312jn.apps.googleusercontent.com"
                     data-callback="GoogleAuth.handleCredentialResponse"
                     data-auto_prompt="false">
                </div>
                <div class="g_id_signin" 
                     data-type="standard"
                     data-size="large"
                     data-theme="outline"
                     data-text="sign_in_with"
                     data-shape="rectangular"
                     data-logo_alignment="left">
                </div>
            </div>
            
            <div id="signedInSection" style="display: none;">
                <div class="detail-text">
                    <strong>Signed in as:</strong> <span id="userEmail"></span><br>
                    <strong>Last Sync:</strong> <span id="lastSync">Never</span>
                </div>
                <button onclick="GoogleAuth.syncToCloud()" class="btn">â˜ï¸ Sync to Cloud</button>
                <button onclick="GoogleAuth.signOut()" class="btn btn-secondary">Sign Out</button>
            </div>
        </div>
    </div>

    <!-- Collection Sharing Section -->
    <div class="detail-section">
        <div class="detail-title">ðŸ“¤ Share Collection</div>
        <div class="form-group">
            <label for="collectionPrivacy">Privacy Setting:</label>
            <select id="collectionPrivacy" onchange="SocialFeatures.updatePrivacySetting(this.value)">
                <option value="private">Private - Only you can see</option>
                <option value="friends">Friends - People you approve</option>
                <option value="public">Public - Anyone can discover</option>
            </select>
        </div>
        <div class="form-group">
            <input type="text" id="shareableLink" readonly placeholder="Your shareable link will appear here">
            <button onclick="SocialFeatures.copyShareLink()" class="btn btn-secondary">ðŸ“‹ Copy Link</button>
        </div>
        <div class="detail-text" style="font-size: 0.85rem; opacity: 0.8;">
            Share this link with friends to let them browse your collection and see what movies you have available to borrow.
        </div>
    </div>

    <!-- Browse Collections Section -->
    <div class="detail-section">
        <div class="detail-title">ðŸ‘¥ Browse Collections</div>
        <div class="form-group">
            <input type="text" id="friendSearch" placeholder="Enter friend's email or share code">
            <button onclick="SocialFeatures.searchFriendCollection()" class="btn">ðŸ” Find Collection</button>
        </div>
        <div id="friendCollections"></div>
    </div>

    <!-- Borrowing Tracker -->
    <div class="detail-section">
        <div class="detail-title">ðŸ“š Borrowing Tracker</div>
        <div id="borrowingList"></div>
        <div id="borrowingEmpty" class="detail-text" style="text-align: center; opacity: 0.7;">
            No active borrowing activities
        </div>
    </div>
</div>
    <!-- Search Results Modal -->
    <div id="searchModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="App.closeModal('searchModal')">&times;</button>
            <h3 style="color: white; margin-bottom: 1rem;">Search Results</h3>
            <div id="searchResults" class="search-results"></div>
            <button onclick="App.useWithoutData()" class="btn btn-secondary">Use Title As-Is (No Movie Data)</button>
        </div>
    </div>

    <!-- Movie Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="App.closeModal('detailModal')">&times;</button>
            <div id="movieDetail"></div>
        </div>
    </div>

    <!-- Barcode Scanner Modal -->
    <div id="scannerModal" class="scanner-modal">
        <div class="scanner-container-modal">
            <div class="scanner-header">
                <h3>ðŸ” Scan Barcode</h3>
                <p class="scanner-hint">Position barcode within the green rectangle</p>
            </div>
            
            <div class="scanner-viewport">
                <div id="barcodeScanner"></div>
                <div class="scanner-overlay" id="scannerOverlay" style="display: none;"></div>
                <div id="scannerPlaceholder" class="scanner-placeholder">
                    <div>ðŸ“±</div>
                    <p>Camera will appear here</p>
                </div>
            </div>

            <div class="scanner-controls">
                <button class="scanner-close" onclick="BarcodeScanner.close()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Global App object to contain all functions
        window.App = (function() {
            const TMDB_API_KEY = '8039283176a74ffd71a1658c6f84a051';
            const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
            const TMDB_IMAGE_BASE = 'https://image.tmdb.org/t/p/w500';

            let copies = [];
            let movies = [];
            let currentResolveItem = null;
            let currentUser = 'default';
            let users = ['default'];
            let currentSort = {
                collection: 'title',
                wishlist: 'title'
            };
            let currentView = {
                collection: 'grid',
                wishlist: 'grid'
            };

            // Initialize app
            function init() {
                loadData();
                updateUI();
                setupEventListeners();
                
                // Auto-resolve movies from shared database
                setTimeout(loadUnresolvedMoviesFromServer, 1000);
            }

            function setupEventListeners() {
                document.getElementById('searchBtn').addEventListener('click', searchMovies);
                document.getElementById('movieForm').addEventListener('submit', handleFormSubmit);
                
                // Close modals when clicking outside
                document.addEventListener('click', function(e) {
                    if (e.target.classList.contains('modal')) {
                        e.target.classList.remove('active');
                    }
                });
            }

            function switchTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[onclick="App.switchTab('${tabName}')"]`).classList.add('active');

                // Update tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabName).classList.add('active');

                // Update content based on tab
                if (tabName === 'collection') {
                    document.getElementById('collectionSort').value = currentSort.collection;
                    updateViewButtons('collection');
                    displayMovies('collection');
                } else if (tabName === 'wishlist') {
                    document.getElementById('wishlistSort').value = currentSort.wishlist;
                    updateViewButtons('wishlist');
                    displayMovies('wishlist');
                } else if (tabName === 'resolve') {
                    displayUnresolvedItems();
                } else if (tabName === 'data') {
                    updateStats();
                    updateUserDropdown();
                } else if (tabName === 'scan') {
                    updateResolveNextSection();
                }
            }

            function updateViewButtons(type) {
                const container = document.getElementById(type).querySelector('.view-toggle');
                container.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
                
                const currentMode = currentView[type] || 'grid';
                const buttons = container.querySelectorAll('.view-btn');
                buttons.forEach(btn => {
                    const onclick = btn.getAttribute('onclick');
                    if (onclick && onclick.includes(`'${currentMode}'`)) {
                        btn.classList.add('active');
                    }
                });
            }

            // Add these modules to your existing JavaScript

// Add this temporarily after the Google script loads
window.addEventListener('load', function() {
    console.log('Current domain:', window.location.origin);
    console.log('Client ID configured:', document.querySelector('[data-client_id]')?.getAttribute('data-client_id'));
});
// Google Authentication Module
window.GoogleAuth = (function() {
    let currentUser = null;
    let isSignedIn = false;
    
    function init() {
        // Check if user is already signed in from previous session
        const savedUser = localStorage.getItem('cineshelf_google_user');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            updateUI(true);
        } else {
            updateUI(false);
        }
    }
    
    function handleCredentialResponse(response) {
        // Decode the JWT token to get user info
        const userInfo = parseJwt(response.credential);
        
        currentUser = {
            email: userInfo.email,
            name: userInfo.name,
            picture: userInfo.picture,
            sub: userInfo.sub // Google user ID
        };
        
        localStorage.setItem('cineshelf_google_user', JSON.stringify(currentUser));
        isSignedIn = true;
        updateUI(true);
        
        // Switch user context to Google account
        if (window.App) {
            const googleUser = `google_${currentUser.sub}`;
            if (window.App.switchUser) {
                window.App.switchUser(googleUser);
            }
        }
        
        showSocialStatus(`Welcome ${currentUser.name}! You can now sync across devices.`, 'success');
        
        // Auto-sync on first login
        setTimeout(syncToCloud, 1000);
    }
    
    function parseJwt(token) {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    }
    
    function updateUI(signedIn) {
        const signInSection = document.getElementById('signInSection');
        const signedInSection = document.getElementById('signedInSection');
        const userEmail = document.getElementById('userEmail');
        
        if (signedIn && currentUser) {
            signInSection.style.display = 'none';
            signedInSection.style.display = 'block';
            userEmail.textContent = currentUser.email;
            
            const lastSync = localStorage.getItem(`cineshelf_last_sync_${currentUser.sub}`);
            document.getElementById('lastSync').textContent = lastSync ? 
                new Date(lastSync).toLocaleString() : 'Never';
            
            // Update sharing link
            SocialFeatures.updateShareLink();
        } else {
            signInSection.style.display = 'block';
            signedInSection.style.display = 'none';
        }
    }
    
    async function syncToCloud() {
        if (!currentUser) {
            showSocialStatus('Please sign in first', 'error');
            return;
        }
        
        try {
            const data = {
                user: `google_${currentUser.sub}`,
                email: currentUser.email,
                name: currentUser.name,
                copies: window.App ? copies : [],
                movies: window.App ? movies : [],
                timestamp: new Date().toISOString(),
                privacy: document.getElementById('collectionPrivacy').value,
                backupLabel: `${currentUser.name}_cloud_${new Date().toISOString().split('T')[0]}`
            };
            
            const response = await fetch('google_backup.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Google-User-ID': currentUser.sub,
                    'X-User-Email': currentUser.email
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                const result = await response.json();
                localStorage.setItem(`cineshelf_last_sync_${currentUser.sub}`, new Date().toISOString());
                document.getElementById('lastSync').textContent = new Date().toLocaleString();
                showSocialStatus('Successfully synced to cloud!', 'success');
            } else {
                throw new Error('Sync failed');
            }
            
        } catch (error) {
            console.error('Cloud sync error:', error);
            showSocialStatus('Cloud sync failed. Using local backup system.', 'error');
            // Fallback to existing backup system
            if (window.App && window.App.backupToServer) {
                window.App.backupToServer();
            }
        }
    }
    
    function signOut() {
        currentUser = null;
        isSignedIn = false;
        localStorage.removeItem('cineshelf_google_user');
        updateUI(false);
        showSocialStatus('Signed out successfully', 'success');
        
        // Switch back to local user
        if (window.App && window.App.switchUser) {
            window.App.switchUser('default');
        }
    }
    
    function showSocialStatus(message, type) {
        const status = document.getElementById('socialStatus');
        if (status) {
            status.textContent = message;
            status.className = `status ${type} show`;
            status.style.display = 'block';
            setTimeout(() => {
                status.classList.remove('show');
                status.style.display = 'none';
            }, 5000);
        }
    }
    
    return {
        init,
        handleCredentialResponse,
        syncToCloud,
        signOut,
        getCurrentUser: () => currentUser,
        isSignedIn: () => isSignedIn
    };
})();

// Social Features Module
window.SocialFeatures = (function() {
    
    function updatePrivacySetting(privacy) {
        const googleUser = GoogleAuth.getCurrentUser();
        if (googleUser) {
            localStorage.setItem(`cineshelf_privacy_${googleUser.sub}`, privacy);
            updateShareLink();
            
            // Save privacy setting to server
            savePricacyToServer(privacy);
        }
    }
    
    async function savePricacyToServer(privacy) {
        const googleUser = GoogleAuth.getCurrentUser();
        if (!googleUser) return;
        
        try {
            await fetch('update_privacy.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Google-User-ID': googleUser.sub
                },
                body: JSON.stringify({
                    user_id: googleUser.sub,
                    privacy: privacy
                })
            });
        } catch (error) {
            console.error('Privacy update failed:', error);
        }
    }
    
    function updateShareLink() {
        const googleUser = GoogleAuth.getCurrentUser();
        const privacy = document.getElementById('collectionPrivacy').value;
        const shareableLink = document.getElementById('shareableLink');
        
        if (googleUser && privacy !== 'private') {
            const baseUrl = window.location.origin + window.location.pathname;
            const shareCode = btoa(googleUser.sub).replace(/[+=]/g, '').substring(0, 8);
            shareableLink.value = `${baseUrl}?view=${shareCode}`;
        } else {
            shareableLink.value = 'Set privacy to Friends or Public to generate link';
        }
    }
    
    function copyShareLink() {
        const shareableLink = document.getElementById('shareableLink');
        if (shareableLink.value && !shareableLink.value.includes('Set privacy')) {
            navigator.clipboard.writeText(shareableLink.value).then(() => {
                GoogleAuth.showSocialStatus('Share link copied to clipboard!', 'success');
            }).catch(() => {
                shareableLink.select();
                document.execCommand('copy');
                GoogleAuth.showSocialStatus('Share link copied to clipboard!', 'success');
            });
        } else {
            GoogleAuth.showSocialStatus('Please set privacy to Friends or Public first', 'error');
        }
    }
    
    async function searchFriendCollection() {
        const searchInput = document.getElementById('friendSearch');
        const query = searchInput.value.trim();
        
        if (!query) {
            GoogleAuth.showSocialStatus('Please enter an email or share code', 'error');
            return;
        }
        
        try {
            const response = await fetch(`search_collection.php?q=${encodeURIComponent(query)}`, {
                headers: {
                    'X-Searcher-ID': GoogleAuth.getCurrentUser()?.sub || 'anonymous'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                displayFriendCollection(data);
            } else if (response.status === 404) {
                GoogleAuth.showSocialStatus('Collection not found or not shared', 'error');
            } else {
                throw new Error('Search failed');
            }
            
        } catch (error) {
            console.error('Friend search error:', error);
            GoogleAuth.showSocialStatus('Could not search collections', 'error');
        }
    }
    
    function displayFriendCollection(collectionData) {
        const container = document.getElementById('friendCollections');
        
        if (!collectionData.copies || collectionData.copies.length === 0) {
            container.innerHTML = '<div class="detail-text">No movies found in this collection</div>';
            return;
        }
        
        container.innerHTML = `
            <div class="detail-section">
                <div class="detail-title">${collectionData.owner_name || 'Friend'}'s Collection</div>
                <div class="detail-text">
                    ${collectionData.copies.length} movies â€¢ Last updated: ${new Date(collectionData.timestamp).toLocaleDateString()}
                </div>
                <div class="friend-collection-grid" style="margin-top: 1rem;">
                    ${collectionData.copies.slice(0, 20).map(copy => {
                        const movie = collectionData.movies?.find(m => m.imdbID === copy.movieId);
                        return `
                            <div class="friend-movie-item" style="display: flex; align-items: center; padding: 0.75rem; background: rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 0.5rem;">
                                <img src="${movie?.posterIMG || ''}" alt="${copy.title}" 
                                     style="width: 40px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 1rem;"
                                     onerror="this.style.display='none'">
                                <div style="flex: 1;">
                                    <div style="color: white; font-weight: 600; margin-bottom: 0.25rem;">${copy.title}</div>
                                    <div style="color: rgba(255,255,255,0.8); font-size: 0.8rem;">
                                        ${copy.format} ${movie?.year ? `â€¢ ${movie.year}` : ''}
                                    </div>
                                </div>
                                <button onclick="SocialFeatures.requestBorrow('${copy.id}', '${collectionData.user_id}')" 
                                        class="btn" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                                    Ask to Borrow
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>
                ${collectionData.copies.length > 20 ? '<div class="detail-text" style="text-align: center; margin-top: 1rem;">...and more</div>' : ''}
            </div>
        `;
    }
    
    async function requestBorrow(copyId, ownerId) {
        const googleUser = GoogleAuth.getCurrentUser();
        if (!googleUser) {
            GoogleAuth.showSocialStatus('Please sign in to request borrowing', 'error');
            return;
        }
        
        try {
            const response = await fetch('borrow_request.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requester-ID': googleUser.sub
                },
                body: JSON.stringify({
                    copy_id: copyId,
                    owner_id: ownerId,
                    requester_id: googleUser.sub,
                    requester_name: googleUser.name,
                    requester_email: googleUser.email
                })
            });
            
            if (response.ok) {
                GoogleAuth.showSocialStatus('Borrow request sent!', 'success');
            } else {
                throw new Error('Request failed');
            }
            
        } catch (error) {
            console.error('Borrow request error:', error);
            GoogleAuth.showSocialStatus('Could not send borrow request', 'error');
        }
    }
    
    return {
        updatePrivacySetting,
        updateShareLink,
        copyShareLink,
        searchFriendCollection,
        requestBorrow
    };
})();

// Initialize Google Auth when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Wait for existing app to initialize first
    setTimeout(() => {
        GoogleAuth.init();
        
        // Check if viewing someone's collection via share link
        const urlParams = new URLSearchParams(window.location.search);
        const viewCode = urlParams.get('view');
        if (viewCode) {
            // Auto-switch to social tab and search for collection
            if (window.App) {
                window.App.switchTab('social');
                document.getElementById('friendSearch').value = viewCode;
                setTimeout(() => SocialFeatures.searchFriendCollection(), 500);
            }
        }
    }, 1000);
});
            // Completely rewritten restore function to fix the cross-device sync issues
async function restoreFromServer() {
    const serverStatus = document.getElementById('serverStatus');
    
    try {
        const endpoints = [
            `restore.php?user=${encodeURIComponent(currentUser)}`, 
            `api/restore/${encodeURIComponent(currentUser)}`, 
            `data/restore.php?user=${encodeURIComponent(currentUser)}`
        ];
        
        let data = null;
        let successEndpoint = null;
        
        // Try each endpoint to find valid backup
        for (const endpoint of endpoints) {
            try {
                const response = await fetch(endpoint, {
                    method: 'GET',
                    headers: {
                        'X-User-ID': currentUser,
                        'X-Restore-Version': '2.1'
                    }
                });
                
                if (response.ok) {
                    const responseData = await response.json();
                    
                    // Validate that we have proper backup data
                    if (responseData && 
                        responseData.copies && 
                        Array.isArray(responseData.copies) &&
                        responseData.movies && 
                        Array.isArray(responseData.movies)) {
                        data = responseData;
                        successEndpoint = endpoint;
                        break;
                    }
                }
            } catch (endpointError) {
                console.log(`Restore endpoint ${endpoint} failed:`, endpointError);
            }
        }
        
        if (!data) {
            throw new Error('No valid backup found on any endpoint');
        }
        
        // Show detailed backup information for confirmation
        const backupLabel = data.backupLabel || 'Unknown backup';
        const backupTime = data.timestamp ? new Date(data.timestamp).toLocaleString() : 'Unknown time';
        const serverCopies = data.copies ? data.copies.length : 0;
        const serverMovies = data.movies ? data.movies.length : 0;
        const serverResolved = data.copies ? data.copies.filter(c => c.resolved).length : 0;
        
        // Show current device stats for comparison
        const currentCopies = copies.length;
        const currentMovies = movies.length;
        const currentResolved = copies.filter(c => c.resolved).length;
        
        const confirmMessage = `ðŸ” Found Server Backup: "${backupLabel}"
ðŸ“… Backup Date: ${backupTime}
ðŸ“Š Server Data: ${serverCopies} items, ${serverMovies} movies, ${serverResolved} resolved
ðŸ“± Your Device: ${currentCopies} items, ${currentMovies} movies, ${currentResolved} resolved

âš ï¸ This will REPLACE all data on this device with server data.
Continue with restore?`;
        
        if (confirm(confirmMessage)) {
            console.log('BEFORE RESTORE - Local data:', {
                copies: copies.length,
                movies: movies.length,
                resolved: copies.filter(c => c.resolved).length
            });
            
            // CRITICAL: Backup current data before replacing (safety net)
            const safetyBackup = {
                copies: JSON.parse(JSON.stringify(copies)),
                movies: JSON.parse(JSON.stringify(movies)),
                timestamp: new Date().toISOString(),
                backupReason: 'safety_before_restore'
            };
            localStorage.setItem(`cineshelf_safety_backup_${currentUser}`, JSON.stringify(safetyBackup));
            
            // CRITICAL: Clear ALL local data first to avoid any contamination
            copies = [];
            movies = [];
            
            // Force clear localStorage to ensure we're not loading anything locally
            localStorage.removeItem(`cineshelf_copies_${currentUser}`);
            localStorage.removeItem(`cineshelf_movies_${currentUser}`);
            
            console.log('CLEARED LOCAL DATA - Now restoring from server...');
            
            // Restore from server with deep cloning to avoid reference issues
            copies = JSON.parse(JSON.stringify(data.copies)) || [];
            movies = JSON.parse(JSON.stringify(data.movies)) || [];
            
            console.log('AFTER RESTORE - Server data loaded:', {
                copies: copies.length,
                movies: movies.length,
                resolved: copies.filter(c => c.resolved).length
            });
            
            // Validate and fix data integrity
            let fixedItems = 0;
            copies.forEach((copy, index) => {
                // Ensure required fields exist
                if (!copy.id) {
                    copy.id = Date.now().toString() + '_' + index;
                    fixedItems++;
                }
                if (!copy.created) {
                    copy.created = new Date().toISOString();
                    fixedItems++;
                }
                if (copy.resolved === undefined) {
                    copy.resolved = !!copy.movieId;
                    fixedItems++;
                }
                
                // Verify movie link exists
                if (copy.movieId && !movies.find(m => m.imdbID === copy.movieId)) {
                    console.warn(`Copy "${copy.title}" links to missing movie ${copy.movieId}`);
                    copy.resolved = false;
                    copy.movieId = null;
                    fixedItems++;
                }
            });
            
            // Ensure movies have required fields
            movies.forEach((movie, index) => {
                if (!movie.imdbID) {
                    movie.imdbID = 'unknown_' + index;
                    fixedItems++;
                }
                if (!movie.title) {
                    movie.title = 'Unknown Title';
                    fixedItems++;
                }
            });
            
            // CRITICAL: Save to localStorage immediately
            saveData();
            
            // Force UI update
            updateUI();
            
            // Show detailed success message
            const finalResolvedCount = copies.filter(c => c.resolved).length;
            const finalUnresolvedCount = copies.filter(c => !c.resolved).length;
            
            serverStatus.innerHTML = `
                <strong>âœ… Restore SUCCESS!</strong><br>
                ðŸ” Backup: ${backupLabel}<br>
                ðŸ“Š Loaded: ${copies.length} items, ${movies.length} movies<br>
                âœ… Resolved: ${finalResolvedCount} | âŒ Unresolved: ${finalUnresolvedCount}<br>
                ðŸ”§ Fixed: ${fixedItems} data issues<br>
                ðŸ“¡ Source: ${successEndpoint}
            `;
            serverStatus.className = 'status success show';
            serverStatus.style.display = 'block';
            setTimeout(() => {
                serverStatus.classList.remove('show');
                serverStatus.style.display = 'none';
            }, 10000);
            
            console.log('Restore completed successfully:', {
                copiesRestored: copies.length,
                moviesRestored: movies.length,
                resolvedItems: finalResolvedCount,
                unresolvedItems: finalUnresolvedCount,
                dataFixesApplied: fixedItems
            });
        }
        
    } catch (error) {
        console.error('Restore error:', error);
        serverStatus.innerHTML = `
            <strong>âŒ Restore Failed</strong><br>
            No backup found for user "${currentUser}"<br>
            <small>Ensure you've backed up data from another device first</small><br>
            Error: ${error.message}
        `;
        serverStatus.className = 'status error show';
        serverStatus.style.display = 'block';
        setTimeout(() => {
            serverStatus.classList.remove('show');
            serverStatus.style.display = 'none';
        }, 8000);
    }
}
            async function searchMovies() {
                const title = document.getElementById('movieTitle').value.trim();
                if (!title) return;

                const btn = document.getElementById('searchBtn');
                const btnText = document.getElementById('searchBtnText');
                const loader = document.getElementById('searchLoader');

                btn.disabled = true;
                btnText.style.display = 'none';
                loader.style.display = 'inline-block';

                try {
                    const response = await fetch(`${TMDB_BASE_URL}/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(title)}`);
                    const data = await response.json();

                    if (data.results && data.results.length > 0) {
                        displaySearchResults(data.results);
                        document.getElementById('searchModal').classList.add('active');
                    } else {
                        showStatus('No movies found. You can still add the title as-is.', 'error');
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    showStatus('Search failed. You can still add the title as-is.', 'error');
                } finally {
                    btn.disabled = false;
                    btnText.style.display = 'inline';
                    loader.style.display = 'none';
                }
            }

            function displaySearchResults(results) {
                const container = document.getElementById('searchResults');
                container.innerHTML = '';

                results.slice(0, 25).forEach(movie => {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'search-result';
                    resultDiv.addEventListener('click', () => selectMovie(movie));

                    const posterUrl = movie.poster_path 
                        ? `${TMDB_IMAGE_BASE}${movie.poster_path}`
                        : '';

                    resultDiv.innerHTML = `
                        <img src="${posterUrl}" alt="${movie.title}" class="search-poster" 
                             onerror="this.style.display='none'">
                        <div class="search-info">
                            <div class="search-title">${movie.title}</div>
                            <div class="search-details">
                                ${movie.release_date ? new Date(movie.release_date).getFullYear() : 'Unknown'} â€¢ 
                                â­ ${movie.vote_average ? movie.vote_average.toFixed(1) : 'N/A'}<br>
                                ${movie.overview ? movie.overview.substring(0, 100) + '...' : 'No description available'}
                            </div>
                        </div>
                    `;

                    container.appendChild(resultDiv);
                });
            }

            async function selectMovie(tmdbMovie) {
                try {
                    const response = await fetch(`${TMDB_BASE_URL}/movie/${tmdbMovie.id}?api_key=${TMDB_API_KEY}&append_to_response=credits`);
                    const details = await response.json();

                    const movie = {
                        imdbID: tmdbMovie.id.toString(),
                        title: details.title,
                        year: details.release_date ? new Date(details.release_date).getFullYear() : null,
                        posterIMG: details.poster_path ? `${TMDB_IMAGE_BASE}${details.poster_path}` : '',
                        imdbRating: details.vote_average || 0,
                        plot: details.overview || '',
                        director: details.credits?.crew?.find(person => person.job === 'Director')?.name || 'Unknown',
                        genre: details.genres?.map(g => g.name).join(', ') || 'Unknown',
                        runtime: details.runtime ? `${details.runtime} min` : 'Unknown',
                        rated: 'Unknown'
                    };

                    const existingMovieIndex = movies.findIndex(m => m.imdbID === movie.imdbID);
                    if (existingMovieIndex === -1) {
                        movies.push(movie);
                    } else {
                        movies[existingMovieIndex] = movie;
                    }

                    document.getElementById('movieTitle').value = movie.title;

                    if (currentResolveItem) {
                        const copyIndex = copies.findIndex(c => c.id === currentResolveItem.id);
                        if (copyIndex !== -1) {
                            copies[copyIndex].movieId = movie.imdbID;
                            copies[copyIndex].resolved = true;
                            copies[copyIndex].title = movie.title;
                            
                            showStatus(`Resolved "${movie.title}"! Moving to next unresolved item...`, 'success');
                            
                            setTimeout(() => {
                                const remainingUnresolved = copies.filter(copy => !copy.resolved && copy.id !== currentResolveItem.id);
                                if (remainingUnresolved.length > 0) {
                                    skipToNextUnresolved();
                                } else {
                                    currentResolveItem = null;
                                    updateResolveNextSection();
                                    showStatus('All items resolved! ðŸŽ‰', 'success');
                                    document.getElementById('movieForm').reset();
                                }
                            }, 1500);
                        }
                    }

                    saveData();
                    closeModal('searchModal');
                    
                    if (!currentResolveItem) {
                        showStatus(`Selected: ${movie.title}`, 'success');
                    }

                } catch (error) {
                    console.error('Error fetching movie details:', error);
                    showStatus('Error getting movie details, but you can continue.', 'error');
                    closeModal('searchModal');
                }
            }

            function useWithoutData() {
                closeModal('searchModal');
                showStatus('You can add the movie without database information.', 'success');
            }

            function handleFormSubmit(e) {
                e.preventDefault();
                
                const isWishlist = e.submitter.name === 'wishlist';
                const formData = {
                    title: document.getElementById('movieTitle').value.trim(),
                    format: document.getElementById('format').value,
                    region: document.getElementById('region').value,
                    discs: parseInt(document.getElementById('discs').value) || 1,
                    edition: document.getElementById('edition').value.trim(),
                    languages: document.getElementById('languages').value.trim(),
                    notes: document.getElementById('notes').value.trim(),
                    upc: document.getElementById('upc').value.trim()
                };

                if (!formData.title || !formData.format) {
                    showStatus('Please fill in required fields (Title and Format)', 'error');
                    return;
                }

                const matchingMovie = movies.find(m => 
                    m.title.toLowerCase() === formData.title.toLowerCase()
                );

                const copy = {
                    id: Date.now().toString(),
                    title: formData.title,
                    format: formData.format,
                    region: formData.region,
                    discs: formData.discs,
                    edition: formData.edition,
                    languages: formData.languages,
                    notes: formData.notes,
                    upc: formData.upc,
                    isWishlist: isWishlist,
                    movieId: matchingMovie ? matchingMovie.imdbID : null,
                    resolved: !!matchingMovie,
                    created: new Date().toISOString()
                };

                copies.push(copy);
                saveData();
                
                document.getElementById('movieForm').reset();
                
                showStatus(`Added "${copy.title}" to ${isWishlist ? 'wishlist' : 'collection'}!`, 'success');
                
                switchTab(isWishlist ? 'wishlist' : 'collection');
            }

            function displayMovies(type) {
                const filteredCopies = copies.filter(copy => 
                    type === 'collection' ? !copy.isWishlist : copy.isWishlist
                );

                const gridId = type + 'Grid';
                const emptyId = type + 'Empty';
                const grid = document.getElementById(gridId);
                const empty = document.getElementById(emptyId);

                if (filteredCopies.length === 0) {
                    grid.innerHTML = '';
                    grid.className = 'movie-grid';
                    empty.style.display = 'block';
                    return;
                }

                empty.style.display = 'none';
                
                const viewMode = currentView[type] || 'grid';
                
                grid.className = 'movie-grid';
                if (viewMode === 'detail') {
                    grid.classList.add('detail-view');
                } else if (viewMode === 'list') {
                    grid.classList.add('list-view');
                }
                
                const sortedCopies = sortCopies(filteredCopies, currentSort[type]);
                
                grid.innerHTML = '';

                sortedCopies.forEach(copy => {
                    const movie = movies.find(m => m.imdbID === copy.movieId);
                    const card = createMovieCard(copy, movie, type, viewMode);
                    grid.appendChild(card);
                });
            }

            function sortCopies(copiesToSort, sortBy) {
                const copies = [...copiesToSort];
                
                const [field, direction] = sortBy.includes('-desc') 
                    ? [sortBy.replace('-desc', ''), 'desc']
                    : [sortBy, 'asc'];

                copies.sort((a, b) => {
                    const movieA = movies.find(m => m.imdbID === a.movieId);
                    const movieB = movies.find(m => m.imdbID === b.movieId);
                    
                    let valueA, valueB;

                    switch (field) {
                        case 'title':
                            valueA = a.title.toLowerCase();
                            valueB = b.title.toLowerCase();
                            break;
                        case 'year':
                            valueA = movieA?.year || 0;
                            valueB = movieB?.year || 0;
                            break;
                        case 'rating':
                            valueA = movieA?.imdbRating || 0;
                            valueB = movieB?.imdbRating || 0;
                            break;
                        case 'runtime':
                            const extractMinutes = (runtime) => {
                                if (!runtime || runtime === 'Unknown') return 0;
                                const match = runtime.match(/(\d+)/);
                                return match ? parseInt(match[1]) : 0;
                            };
                            valueA = extractMinutes(movieA?.runtime);
                            valueB = extractMinutes(movieB?.runtime);
                            break;
                        case 'director':
                            valueA = (movieA?.director || 'Unknown').toLowerCase();
                            valueB = (movieB?.director || 'Unknown').toLowerCase();
                            break;
                        case 'genre':
                            valueA = (movieA?.genre || 'Unknown').toLowerCase();
                            valueB = (movieB?.genre || 'Unknown').toLowerCase();
                            break;
                        case 'format':
                            valueA = a.format.toLowerCase();
                            valueB = b.format.toLowerCase();
                            break;
                        case 'added':
                            valueA = new Date(a.created);
                            valueB = new Date(b.created);
                            break;
                        default:
                            valueA = a.title.toLowerCase();
                            valueB = b.title.toLowerCase();
                    }

                    let comparison = 0;
                    if (valueA < valueB) comparison = -1;
                    if (valueA > valueB) comparison = 1;
                    
                    return direction === 'desc' ? -comparison : comparison;
                });

                return copies;
            }

            function sortMovies(type, sortBy) {
                currentSort[type] = sortBy;
                displayMovies(type);
                
                try {
                    localStorage.setItem('cineshelf_sort', JSON.stringify(currentSort));
                } catch (error) {
                    console.error('Error saving sort preference:', error);
                }
            }

            function createMovieCard(copy, movie, type, viewMode) {
                const card = document.createElement('div');
                card.className = 'movie-card';
                card.addEventListener('click', () => showMovieDetail(copy, movie));

                const posterUrl = movie?.posterIMG || '';
                const year = movie?.year || 'Unknown';
                const rating = movie?.imdbRating ? `â­ ${movie.imdbRating.toFixed(1)}` : '';

                if (viewMode === 'detail') {
                    card.classList.add('detail-item');
                    
                    card.innerHTML = `
                        <img src="${posterUrl}" alt="${copy.title}" class="movie-poster" 
                             onerror="this.style.background='rgba(255,255,255,0.1)'; this.innerHTML='ðŸŽ¬'; this.style.display='flex'; this.style.alignItems='center'; this.style.justifyContent='center'; this.style.fontSize='2rem';">
                        <div class="movie-content">
                            <div class="movie-title">${copy.title}</div>
                            <div class="movie-info">
                                ${year} â€¢ ${copy.format} â€¢ ${rating}
                            </div>
                            <div class="movie-details">
                                ${movie ? `
                                    Director: ${movie.director}<br>
                                    Genre: ${movie.genre}<br>
                                ` : ''}
                                ${copy.edition ? `Edition: ${copy.edition}<br>` : ''}
                                ${copy.region ? `Region: ${copy.region}` : ''}
                            </div>
                        </div>
                    `;
                } else if (viewMode === 'list') {
                    card.classList.add('list-item');
                    
                    card.innerHTML = `
                        <img src="${posterUrl}" alt="${copy.title}" class="movie-poster" 
                             onerror="this.style.background='rgba(255,255,255,0.1)'; this.innerHTML='ðŸŽ¬'; this.style.display='flex'; this.style.alignItems='center'; this.style.justifyContent='center'; this.style.fontSize='1rem';">
                        <div class="movie-content">
                            <div class="movie-title">${copy.title}</div>
                            <div class="movie-info">${year} â€¢ ${copy.format}</div>
                        </div>
                    `;
                } else {
                    card.innerHTML = `
                        <img src="${posterUrl}" alt="${copy.title}" class="movie-poster" 
                             onerror="this.style.background='rgba(255,255,255,0.1)'; this.innerHTML='ðŸŽ¬'; this.style.display='flex'; this.style.alignItems='center'; this.style.justifyContent='center'; this.style.fontSize='2rem';">
                        <div class="movie-title">${copy.title}</div>
                        <div class="movie-info">
                            ${year} â€¢ ${copy.format}<br>
                            ${rating}
                        </div>
                    `;
                }

                return card;
            }

            function showMovieDetail(copy, movie) {
                const modal = document.getElementById('detailModal');
                const content = document.getElementById('movieDetail');

                const posterUrl = movie?.posterIMG || '';
                const oppositeType = copy.isWishlist ? 'collection' : 'wishlist';
                const oppositeLabel = copy.isWishlist ? 'Collection' : 'Wishlist';

                content.innerHTML = `
                    <img src="${posterUrl}" alt="${copy.title}" class="movie-detail-poster" 
                         onerror="this.style.background='rgba(255,255,255,0.1)'; this.innerHTML='ðŸŽ¬'; this.style.display='flex'; this.style.alignItems='center'; this.style.justifyContent='center'; this.style.fontSize='3rem';">

                    <div class="detail-section">
                        <div class="detail-title">${copy.title}</div>
                        <div class="detail-text">
                            ${movie ? `
                                <strong>Year:</strong> ${movie.year || 'Unknown'}<br>
                                <strong>Rating:</strong> ${movie.imdbRating ? `â­ ${movie.imdbRating.toFixed(1)}/10` : 'Not rated'}<br>
                                <strong>Runtime:</strong> ${movie.runtime}<br>
                                <strong>Director:</strong> ${movie.director}<br>
                                <strong>Genre:</strong> ${movie.genre}<br><br>
                                <strong>Plot:</strong><br>${movie.plot}
                            ` : 'No movie information available'}
                        </div>
                    </div>

                    <div class="detail-section">
                        <div class="detail-title">Your Copy Details</div>
                        <div class="detail-text">
                            <strong>Format:</strong> ${copy.format}<br>
                            ${copy.region ? `<strong>Region:</strong> ${copy.region}<br>` : ''}
                            <strong>Discs:</strong> ${copy.discs}<br>
                            ${copy.edition ? `<strong>Edition:</strong> ${copy.edition}<br>` : ''}
                            ${copy.languages ? `<strong>Languages:</strong> ${copy.languages}<br>` : ''}
                            ${copy.upc ? `<strong>UPC:</strong> ${copy.upc}<br>` : ''}
                            ${copy.notes ? `<strong>Notes:</strong> ${copy.notes}<br>` : ''}
                            <strong>Added:</strong> ${new Date(copy.created).toLocaleDateString()}
                        </div>
                    </div>

                    <button onclick="App.moveCopy('${copy.id}', ${!copy.isWishlist})" class="btn">
                        Move to ${oppositeLabel}
                    </button>
                    <button onclick="App.deleteCopy('${copy.id}')" class="btn btn-danger">
                        Delete
                    </button>
                `;

                modal.classList.add('active');
            }

            function moveCopy(copyId, toWishlist) {
                const copyIndex = copies.findIndex(c => c.id === copyId);
                if (copyIndex !== -1) {
                    copies[copyIndex].isWishlist = toWishlist;
                    saveData();
                    closeModal('detailModal');
                    showStatus(`Moved to ${toWishlist ? 'wishlist' : 'collection'}!`, 'success');
                    updateUI();
                }
            }

            function deleteCopy(copyId) {
                if (confirm('Are you sure you want to delete this item?')) {
                    copies = copies.filter(c => c.id !== copyId);
                    saveData();
                    closeModal('detailModal');
                    showStatus('Item deleted!', 'success');
                    updateUI();
                }
            }

            function displayUnresolvedItems() {
                const unresolvedCopies = copies.filter(copy => !copy.resolved);
                const container = document.getElementById('resolveList');
                const empty = document.getElementById('resolveEmpty');

                if (unresolvedCopies.length === 0) {
                    container.innerHTML = '';
                    empty.style.display = 'block';
                    return;
                }

                empty.style.display = 'none';
                container.innerHTML = '';

                unresolvedCopies.forEach(copy => {
                    const item = document.createElement('div');
                    item.className = 'resolve-item';

                    item.innerHTML = `
                        <div class="resolve-title">${copy.title}</div>
                        <div class="resolve-details">
                            Format: ${copy.format} â€¢ 
                            ${copy.isWishlist ? 'Wishlist' : 'Collection'}<br>
                            ${copy.edition ? `Edition: ${copy.edition} â€¢ ` : ''}
                            Added: ${new Date(copy.created).toLocaleDateString()}
                        </div>
                        <button onclick="App.findMovieData('${copy.id}')" class="btn">
                            ðŸ” Find Movie Data
                        </button>
                    `;

                    container.appendChild(item);
                });
            }

            function findMovieData(copyId) {
                const copy = copies.find(c => c.id === copyId);
                if (!copy) return;

                currentResolveItem = copy;
                
                document.getElementById('movieTitle').value = copy.title;
                document.getElementById('format').value = copy.format;
                document.getElementById('region').value = copy.region;
                document.getElementById('discs').value = copy.discs;
                document.getElementById('edition').value = copy.edition;
                document.getElementById('languages').value = copy.languages;
                document.getElementById('upc').value = copy.upc;
                document.getElementById('notes').value = copy.notes;

                updateResolveNextSection();
                switchTab('scan');
                
                showStatus(`Ready to search for "${copy.title}" - click Search Movie Database`, 'success');
            }

            function updateResolveNextSection() {
                const section = document.getElementById('resolveNextSection');
                const info = document.getElementById('resolveNextInfo');
                
                if (currentResolveItem) {
                    const unresolvedCopies = copies.filter(copy => !copy.resolved);
                    const currentIndex = unresolvedCopies.findIndex(c => c.id === currentResolveItem.id);
                    const remaining = unresolvedCopies.length;
                    
                    section.style.display = 'block';
                    info.innerHTML = `
                        <strong>Currently resolving:</strong> ${currentResolveItem.title}<br>
                        <strong>Format:</strong> ${currentResolveItem.format} â€¢ 
                        <strong>Type:</strong> ${currentResolveItem.isWishlist ? 'Wishlist' : 'Collection'}<br>
                        <strong>Progress:</strong> ${currentIndex + 1} of ${remaining} unresolved items
                    `;
                } else {
                    section.style.display = 'none';
                }
            }

            function skipToNextUnresolved() {
                const unresolvedCopies = copies.filter(copy => !copy.resolved);
                
                if (unresolvedCopies.length === 0) {
                    currentResolveItem = null;
                    updateResolveNextSection();
                    showStatus('All items have been resolved!', 'success');
                    return;
                }

                let nextItem = null;
                
                if (currentResolveItem) {
                    const currentIndex = unresolvedCopies.findIndex(c => c.id === currentResolveItem.id);
                    const nextIndex = (currentIndex + 1) % unresolvedCopies.length;
                    nextItem = unresolvedCopies[nextIndex];
                } else {
                    nextItem = unresolvedCopies[0];
                }

                findMovieData(nextItem.id);
            }

            function updateUI() {
                const activeTab = document.querySelector('.tab.active');
                if (activeTab) {
                    const tabName = activeTab.textContent.toLowerCase().trim();
                    if (tabName === 'collection') {
                        document.getElementById('collectionSort').value = currentSort.collection;
                        updateViewButtons('collection');
                        displayMovies('collection');
                    } else if (tabName === 'wishlist') {
                        document.getElementById('wishlistSort').value = currentSort.wishlist;
                        updateViewButtons('wishlist');
                        displayMovies('wishlist');
                    } else if (tabName === 'resolve') {
                        displayUnresolvedItems();
                    } else if (tabName === 'data') {
                        updateStats();
                        updateUserDropdown();
                    } else if (tabName === 'scan') {
                        updateResolveNextSection();
                    }
                }
            }

            function exportData() {
                const csvRows = [];
                csvRows.push([
                    'Title', 'Format', 'Region', 'Discs', 'Edition', 'Languages', 'UPC', 'Notes',
                    'Type', 'Year', 'Rating', 'Director', 'Genre', 'Plot', 'Added'
                ]);

                copies.forEach(copy => {
                    const movie = movies.find(m => m.imdbID === copy.movieId);
                    csvRows.push([
                        copy.title,
                        copy.format,
                        copy.region || '',
                        copy.discs,
                        copy.edition || '',
                        copy.languages || '',
                        copy.upc || '',
                        copy.notes || '',
                        copy.isWishlist ? 'Wishlist' : 'Collection',
                        movie?.year || '',
                        movie?.imdbRating || '',
                        movie?.director || '',
                        movie?.genre || '',
                        movie?.plot || '',
                        new Date(copy.created).toLocaleDateString()
                    ]);
                });

                const csvContent = csvRows.map(row => 
                    row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
                ).join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cineshelf-${currentUser}-export-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);

                showStatus('Collection exported successfully!', 'success');
            }

            function importData(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        let importedData;
                        
                        if (file.name.endsWith('.json')) {
                            importedData = JSON.parse(e.target.result);
                            
                            if (importedData.copies && importedData.movies) {
                                copies = importedData.copies;
                                movies = importedData.movies;
                            } else {
                                throw new Error('Invalid JSON format');
                            }
                        } else if (file.name.endsWith('.csv')) {
                            const lines = e.target.result.split('\n');
                            const headers = lines[0].split(',').map(h => h.replace(/"/g, ''));
                            
                            copies = [];
                            movies = [];
                            
                            for (let i = 1; i < lines.length; i++) {
                                if (!lines[i].trim()) continue;
                                
                                const values = lines[i].split('","').map(v => v.replace(/"/g, ''));
                                
                                const copy = {
                                    id: Date.now().toString() + i,
                                    title: values[0] || '',
                                    format: values[1] || '',
                                    region: values[2] || '',
                                    discs: parseInt(values[3]) || 1,
                                    edition: values[4] || '',
                                    languages: values[5] || '',
                                    upc: values[6] || '',
                                    notes: values[7] || '',
                                    isWishlist: values[8] === 'Wishlist',
                                    movieId: null,
                                    resolved: false,
                                    created: new Date().toISOString()
                                };
                                
                                copies.push(copy);
                            }
                        }

                        saveData();
                        updateUI();
                        showStatus(`Imported ${copies.length} items successfully!`, 'success');
                        
                    } catch (error) {
                        console.error('Import error:', error);
                        showStatus('Import failed. Please check the file format.', 'error');
                    }
                };

                reader.readAsText(file);
                event.target.value = '';
            }

            function clearAllData() {
                if (confirm('Are you sure you want to clear ALL data for this user? This cannot be undone!')) {
                    if (confirm('This will delete your entire collection and wishlist. Are you absolutely sure?')) {
                        copies = [];
                        movies = [];
                        saveData();
                        updateUI();
                        showStatus('All data cleared!', 'success');
                    }
                }
            }

            function updateStats() {
                const collectionCount = copies.filter(c => !c.isWishlist).length;
                const wishlistCount = copies.filter(c => c.isWishlist).length;
                const unresolvedCount = copies.filter(c => !c.resolved).length;
                
                const formatStats = {};
                copies.forEach(copy => {
                    formatStats[copy.format] = (formatStats[copy.format] || 0) + 1;
                });

                const statsHtml = `
                    <strong>Current User:</strong> ${currentUser === 'default' ? 'Default User' : currentUser}<br>
                    <strong>Collection:</strong> ${collectionCount} items<br>
                    <strong>Wishlist:</strong> ${wishlistCount} items<br>
                    <strong>Unresolved:</strong> ${unresolvedCount} items<br>
                    <strong>Total Movies:</strong> ${movies.length} with data<br><br>
                    <strong>Format Breakdown:</strong><br>
                    ${Object.entries(formatStats).map(([format, count]) => 
                        `${format}: ${count}`
                    ).join('<br>')}
                `;

                document.getElementById('stats').innerHTML = statsHtml;
            }

            function closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            }

            function showStatus(message, type) {
                const status = document.getElementById('status');
                status.textContent = message;
                status.className = `status ${type} show`;
                status.style.display = 'block';
                
                setTimeout(() => {
                    status.classList.remove('show');
                    status.style.display = 'none';
                }, 5000);
            }

            function saveData() {
                try {
                    localStorage.setItem(`cineshelf_copies_${currentUser}`, JSON.stringify(copies));
                    localStorage.setItem(`cineshelf_movies_${currentUser}`, JSON.stringify(movies));
                    localStorage.setItem('cineshelf_users', JSON.stringify(users));
                    localStorage.setItem('cineshelf_current_user', currentUser);
                } catch (error) {
                    console.error('Error saving data:', error);
                    showStatus('Warning: Could not save data to device storage', 'error');
                }
            }

            function loadData() {
                try {
                    const savedUsers = localStorage.getItem('cineshelf_users');
                    const savedCurrentUser = localStorage.getItem('cineshelf_current_user');
                    
                    if (savedUsers) {
                        users = JSON.parse(savedUsers);
                    }
                    
                    if (savedCurrentUser && users.includes(savedCurrentUser)) {
                        currentUser = savedCurrentUser;
                    }
                    
                    const savedCopies = localStorage.getItem(`cineshelf_copies_${currentUser}`);
                    const savedMovies = localStorage.getItem(`cineshelf_movies_${currentUser}`);
                    const savedSort = localStorage.getItem('cineshelf_sort');
                    const savedView = localStorage.getItem('cineshelf_view');
                    
                    if (savedCopies) {
                        copies = JSON.parse(savedCopies);
                    }
                    
                    if (savedMovies) {
                        movies = JSON.parse(savedMovies);
                    }
                    
                    if (savedSort) {
                        currentSort = { ...currentSort, ...JSON.parse(savedSort) };
                    }
                    
                    if (savedView) {
                        currentView = { ...currentView, ...JSON.parse(savedView) };
                    }
                    
                    updateUserDropdown();
                } catch (error) {
                    console.error('Error loading data:', error);
                    copies = [];
                    movies = [];
                }
            }

            function updateUserDropdown() {
                const dropdown = document.getElementById('currentUser');
                if (!dropdown) return;
                
                dropdown.innerHTML = '';
                
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user;
                    option.textContent = user === 'default' ? 'Default User' : user;
                    if (user === currentUser) {
                        option.selected = true;
                    }
                    dropdown.appendChild(option);
                });
            }

            function switchUser(newUser) {
                if (newUser === currentUser) return;
                
                saveData();
                currentUser = newUser;
                
                const savedCopies = localStorage.getItem(`cineshelf_copies_${currentUser}`);
                const savedMovies = localStorage.getItem(`cineshelf_movies_${currentUser}`);
                
                copies = savedCopies ? JSON.parse(savedCopies) : [];
                movies = savedMovies ? JSON.parse(savedMovies) : [];
                
                currentResolveItem = null;
                localStorage.setItem('cineshelf_current_user', currentUser);
                
                updateUI();
                showStatus(`Switched to user: ${newUser === 'default' ? 'Default User' : newUser}`, 'success');
            }

            function addUser() {
                const input = document.getElementById('newUserName');
                const userName = input.value.trim();
                
                if (!userName) {
                    showStatus('Please enter a user name', 'error');
                    return;
                }
                
                if (users.includes(userName)) {
                    showStatus('User already exists', 'error');
                    return;
                }
                
                users.push(userName);
                updateUserDropdown();
                saveData();
                
                input.value = '';
                showStatus(`User "${userName}" added successfully`, 'success');
            }

            function deleteCurrentUser() {
                if (currentUser === 'default') {
                    showStatus('Cannot delete the default user', 'error');
                    return;
                }
                
                if (users.length <= 1) {
                    showStatus('Cannot delete the last user', 'error');
                    return;
                }
                
                if (confirm(`Are you sure you want to delete user "${currentUser}" and all their data?`)) {
                    localStorage.removeItem(`cineshelf_copies_${currentUser}`);
                    localStorage.removeItem(`cineshelf_movies_${currentUser}`);
                    
                    users = users.filter(user => user !== currentUser);
                    switchUser('default');
                    
                    showStatus('User deleted successfully', 'success');
                }
            }

            // Enhanced backup function with better labeling
async function backupToServer() {
    const serverStatus = document.getElementById('serverStatus');
    
    try {
        // Create detailed backup data with clear identification
        const backupLabel = `${currentUser}_${navigator.platform}_${new Date().toISOString().split('T')[0]}`;
        const data = {
            user: currentUser,
            copies: copies,
            movies: movies,
            timestamp: new Date().toISOString(),
            backupLabel: backupLabel,
            deviceInfo: {
                platform: navigator.platform,
                userAgent: navigator.userAgent.substring(0, 100),
                language: navigator.language,
                screenSize: `${screen.width}x${screen.height}`
            },
            stats: {
                totalCopies: copies.length,
                totalMovies: movies.length,
                resolvedCopies: copies.filter(c => c.resolved).length,
                collectionItems: copies.filter(c => !c.isWishlist).length,
                wishlistItems: copies.filter(c => c.isWishlist).length
            },
            version: "2.1"
        };
        
        console.log('BACKUP DATA BEING SENT:', {
            copies: data.copies.length,
            movies: data.movies.length,
            resolved: data.stats.resolvedCopies,
            label: backupLabel
        });
        
        const endpoints = ['backup.php', 'api/backup', 'data/backup.php'];
        let success = false;
        
        for (const endpoint of endpoints) {
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': currentUser,
                        'X-Backup-Version': '2.1',
                        'X-Backup-Label': backupLabel
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    success = true;
                    
                    // Store backup info locally for verification
                    localStorage.setItem(`cineshelf_last_backup_${currentUser}`, JSON.stringify({
                        timestamp: data.timestamp,
                        itemCount: copies.length,
                        movieCount: movies.length,
                        resolvedCount: data.stats.resolvedCopies,
                        endpoint: endpoint,
                        label: backupLabel
                    }));
                    
                    serverStatus.innerHTML = `
                        <strong>âœ… Backup SUCCESS!</strong><br>
                        ðŸ“ Label: ${backupLabel}<br>
                        ðŸ“Š Saved: ${copies.length} items, ${movies.length} movies<br>
                        âœ… Resolved: ${data.stats.resolvedCopies}<br>
                        ðŸ“¡ Endpoint: ${endpoint}
                    `;
                    serverStatus.className = 'status success show';
                    serverStatus.style.display = 'block';
                    setTimeout(() => {
                        serverStatus.classList.remove('show');
                        serverStatus.style.display = 'none';
                    }, 8000);
                    break;
                }
            } catch (endpointError) {
                console.log(`Endpoint ${endpoint} failed:`, endpointError);
            }
        }
        
        if (!success) {
            throw new Error('All backup endpoints failed');
        }
        
    } catch (error) {
        console.error('Backup error:', error);
        serverStatus.innerHTML = `
            <strong>âŒ Backup Failed</strong><br>
            Please ensure backup.php is on your server<br>
            <small>Attempted to backup: ${copies.length} items, ${movies.length} movies</small>
        `;
        serverStatus.className = 'status error show';
        serverStatus.style.display = 'block';
        setTimeout(() => {
            serverStatus.classList.remove('show');
            serverStatus.style.display = 'none';
        }, 8000);
    }
}

            async function restoreFromServer() {
                const serverStatus = document.getElementById('serverStatus');
                
                try {
                    // Try multiple restore endpoints
                    const endpoints = [`restore.php?user=${encodeURIComponent(currentUser)}`, 
                                     `api/restore/${encodeURIComponent(currentUser)}`, 
                                     `data/restore.php?user=${encodeURIComponent(currentUser)}`];
                    
                    let data = null;
                    let successEndpoint = null;
                    
                    for (const endpoint of endpoints) {
                        try {
                            const response = await fetch(endpoint, {
                                method: 'GET',
                                headers: {
                                    'X-User-ID': currentUser,
                                    'X-Restore-Version': '2.1'
                                }
                            });
                            
                            if (response.ok) {
                                const responseData = await response.json();
                                
                                // Validate data structure more thoroughly
                                if (responseData && 
                                    responseData.copies && 
                                    Array.isArray(responseData.copies) &&
                                    responseData.movies && 
                                    Array.isArray(responseData.movies)) {
                                    data = responseData;
                                    successEndpoint = endpoint;
                                    break;
                                }
                            }
                        } catch (endpointError) {
                            console.log(`Restore endpoint ${endpoint} failed:`, endpointError);
                        }
                    }
                    
                    if (!data) {
                        throw new Error('No valid backup found on any endpoint');
                    }
                    
                    // Log what we're about to restore
                    console.log('Restoring data:', {
                        copies: data.copies.length,
                        movies: data.movies.length,
                        serverVersion: data.version || 'unknown'
                    });
                    
                    // Get backup info for comparison
                    const lastBackup = localStorage.getItem(`cineshelf_last_backup_${currentUser}`);
                    let backupInfo = '';
                    if (lastBackup) {
                        const info = JSON.parse(lastBackup);
                        backupInfo = `\nLast backup: ${new Date(info.timestamp).toLocaleString()}\nMovie data: ${info.movieCount || 'unknown'} movies`;
                    }
                    
                    // Show detailed confirmation with movie data info
                    const currentResolvedCount = copies.filter(c => c.resolved).length;
                    const serverResolvedCount = data.copies.filter(c => c.resolved).length;
                    
                    const confirmMessage = `Found server backup:\nâ€¢ ${data.copies.length} items\nâ€¢ ${data.movies.length} movies with full data\nâ€¢ ${serverResolvedCount} resolved items${backupInfo}\n\nYour current device:\nâ€¢ ${copies.length} items\nâ€¢ ${movies.length} movies with full data\nâ€¢ ${currentResolvedCount} resolved items\n\nRestore from server? This will replace your current data.`;
                    
                    if (confirm(confirmMessage)) {
                        // Backup current data before replacing
                        const backupCurrentData = {
                            copies: JSON.parse(JSON.stringify(copies)),
                            movies: JSON.parse(JSON.stringify(movies)),
                            timestamp: new Date().toISOString(),
                            backupReason: 'before_restore'
                        };
                        localStorage.setItem(`cineshelf_restore_backup_${currentUser}`, JSON.stringify(backupCurrentData));
                        
                        // Clear current data first to avoid conflicts
                        copies = [];
                        movies = [];
                        
                        // Restore from server with deep cloning
                        copies = JSON.parse(JSON.stringify(data.copies)) || [];
                        movies = JSON.parse(JSON.stringify(data.movies)) || [];
                        
                        // Ensure data integrity and fix any issues
                        copies.forEach((copy, index) => {
                            if (!copy.id) copy.id = Date.now().toString() + '_' + index;
                            if (!copy.created) copy.created = new Date().toISOString();
                            if (copy.resolved === undefined) copy.resolved = !!copy.movieId;
                            
                            // Verify movie link exists
                            if (copy.movieId && !movies.find(m => m.imdbID === copy.movieId)) {
                                console.warn(`Copy "${copy.title}" links to missing movie ${copy.movieId}`);
                                copy.resolved = false;
                                copy.movieId = null;
                            }
                        });
                        
                        // Ensure movies have required fields
                        movies.forEach((movie, index) => {
                            if (!movie.imdbID) movie.imdbID = 'unknown_' + index;
                            if (!movie.title) movie.title = 'Unknown Title';
                        });
                        
                        // Save restored data
                        saveData();
                        updateUI();
                        
                        // Show success with detailed stats
                        const finalResolvedCount = copies.filter(c => c.resolved).length;
                        const finalUnresolvedCount = copies.filter(c => !c.resolved).length;
                        
                        serverStatus.innerHTML = `
                            <strong>Restore successful!</strong><br>
                            ${copies.length} items, ${movies.length} movies restored<br>
                            <small>${finalResolvedCount} resolved, ${finalUnresolvedCount} unresolved â€¢ ${successEndpoint}</small>
                        `;
                        serverStatus.className = 'status success';
                        serverStatus.style.display = 'block';
                        setTimeout(() => serverStatus.style.display = 'none', 6000);
                        
                        console.log('Restore completed:', {
                            copiesRestored: copies.length,
                            moviesRestored: movies.length,
                            resolvedItems: finalResolvedCount,
                            unresolvedItems: finalUnresolvedCount
                        });
                    }
                    
                } catch (error) {
                    console.error('Restore error:', error);
                    serverStatus.innerHTML = `
                        <strong>Restore failed</strong><br>
                        No backup found for user "${currentUser}"<br>
                        <small>Make sure you've backed up data from another device first</small>
                    `;
                    serverStatus.className = 'status error';
                    serverStatus.style.display = 'block';
                    setTimeout(() => serverStatus.style.display = 'none', 6000);
                }
            }

            function setViewMode(type, mode) {
                currentView[type] = mode;
                
                const container = document.getElementById(type).querySelector('.view-toggle');
                container.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
                
                const buttons = container.querySelectorAll('.view-btn');
                buttons.forEach(btn => {
                    const onclick = btn.getAttribute('onclick');
                    if (onclick && onclick.includes(`'${mode}'`)) {
                        btn.classList.add('active');
                    }
                });
                
                displayMovies(type);
                
                try {
                    localStorage.setItem('cineshelf_view', JSON.stringify(currentView));
                } catch (error) {
                    console.error('Error saving view preference:', error);
                }
            }

            function setTitleFromCoverScanner(title) {
                document.getElementById('movieTitle').value = title;
                switchTab('scan');
                showStatus(`Title set from cover scan: ${title}`, 'success');
            }

            // Placeholder function for server integration
            async function loadUnresolvedMoviesFromServer() {
                // This would connect to a shared movie database
                // For now, it's just a placeholder
                console.log('Auto-resolve placeholder - would check server for movie data');
            }

            return {
                switchTab,
                sortMovies,
                setViewMode,
                skipToNextUnresolved,
                moveCopy,
                deleteCopy,
                findMovieData,
                exportData,
                importData,
                clearAllData,
                useWithoutData,
                closeModal,
                showStatus,
                setTitleFromCoverScanner,
                switchUser,
                addUser,
                deleteCurrentUser,
                backupToServer,
                restoreFromServer,
                init
            };
        })();

        // Cover Scanner Module
        window.CoverScanner = (function() {
            let stream = null;
            let capturedImages = [];
            
            const video = document.getElementById('coverVideo');
            const canvas = document.getElementById('coverCanvas');
            const ctx = canvas.getContext('2d');
            const capturedImagesDiv = document.getElementById('capturedImages');
            const fileInput = document.getElementById('fileInput');

            function init() {
                fileInput.addEventListener('change', function(e) {
                    const files = Array.from(e.target.files);
                    files.forEach(file => {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            addCapturedImage(event.target.result);
                        };
                        reader.readAsDataURL(file);
                    });
                });
            }

            function startCamera() {
                navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' }
                }).then(mediaStream => {
                    stream = mediaStream;
                    video.srcObject = stream;
                    video.style.display = 'block';
                    document.getElementById('captureBtn').disabled = false;
                }).catch(err => {
                    showCoverStatus('Camera error: ' + err.message, 'error');
                });
            }

            function stopCamera() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    video.style.display = 'none';
                    document.getElementById('captureBtn').disabled = true;
                }
            }

            function captureImage() {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
                
                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                addCapturedImage(imageData);
            }

            function addCapturedImage(imageData) {
                capturedImages.push(imageData);
                
                const img = document.createElement('img');
                img.src = imageData;
                img.className = 'captured-image';
                img.onclick = () => removeImage(imageData);
                img.title = 'Click to remove';
                
                capturedImagesDiv.appendChild(img);
                
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('clearBtn').disabled = false;
            }

            function removeImage(imageData) {
                capturedImages = capturedImages.filter(img => img !== imageData);
                capturedImagesDiv.innerHTML = '';
                capturedImages.forEach(img => addCapturedImage(img));
                
                if (capturedImages.length === 0) {
                    document.getElementById('analyzeBtn').disabled = true;
                    document.getElementById('clearBtn').disabled = true;
                }
            }

            function clearImages() {
                if (capturedImages.length === 0) {
                    showCoverStatus('No images to clear!', 'error');
                    return;
                }
                
                if (confirm(`Are you sure you want to clear all ${capturedImages.length} images?`)) {
                    capturedImages = [];
                    capturedImagesDiv.innerHTML = '';
                    fileInput.value = '';
                    
                    document.getElementById('analyzeBtn').disabled = true;
                    document.getElementById('clearBtn').disabled = true;
                    
                    showCoverStatus('All images cleared!', 'success');
                }
            }

            async function testAPI() {
                const apiKey = document.getElementById('apiKey').value.trim();
                if (!apiKey) {
                    showCoverStatus('Please enter your OpenAI API key', 'error');
                    return;
                }
                
                try {
                    const response = await fetch('https://api.openai.com/v1/models', {
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        showCoverStatus(`âœ… API works! You have ${data.data.length} models available.`, 'success');
                    } else {
                        showCoverStatus(`âŒ API Error: ${JSON.stringify(data)}`, 'error');
                    }
                } catch (error) {
                    showCoverStatus(`âŒ Network Error: ${error.message}`, 'error');
                }
            }

            async function analyzeImages() {
                const apiKey = document.getElementById('apiKey').value.trim();
                
                if (!apiKey) {
                    showCoverStatus('Please enter your OpenAI API key', 'error');
                    return;
                }
                
                if (capturedImages.length === 0) {
                    showCoverStatus('Please capture or upload at least one image', 'error');
                    return;
                }
                
                document.getElementById('coverLoading').style.display = 'block';
                
                try {
                    const messages = [
                        {
                            role: "user",
                            content: [
                                {
                                    type: "text",
                                    text: "Please analyze these DVD cover images and extract ONLY the movie titles. Return a simple numbered list with just the movie titles, no actors, directors, studios, or other text. Format: 1. Movie Title\\n2. Another Movie Title"
                                },
                                ...capturedImages.map(imageData => ({
                                    type: "image_url",
                                    image_url: {
                                        url: imageData,
                                        detail: "high"
                                    }
                                }))
                            ]
                        }
                    ];
                    
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: "gpt-4o-mini",
                            messages: messages,
                            max_tokens: 1000
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        const titles = extractTitlesFromResponse(data.choices[0].message.content);
                        displayTitles(titles);
                        showCoverStatus(`âœ… Analysis complete! Found ${titles.length} titles.`, 'success');
                    } else {
                        showCoverStatus(`âŒ API Error: ${JSON.stringify(data)}`, 'error');
                    }
                    
                } catch (error) {
                    showCoverStatus(`âŒ Error: ${error.message}`, 'error');
                } finally {
                    document.getElementById('coverLoading').style.display = 'none';
                }
            }

            function extractTitlesFromResponse(text) {
                const lines = text.split('\n');
                const titles = [];
                
                for (const line of lines) {
                    const match = line.match(/^\d+\.\s*(.+)/);
                    if (match) {
                        titles.push(match[1].trim());
                    }
                }
                
                return titles;
            }

            function displayTitles(titles) {
                const container = document.getElementById('titlesContainer');
                
                titles.forEach(title => {
                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'title-item';
                    
                    titleDiv.innerHTML = `
                        <input type="text" value="${title}" placeholder="Movie title">
                        <div class="title-actions">
                            <button class="use-btn" onclick="CoverScanner.useTitle(this)">Use</button>
                            <button class="remove-btn" onclick="this.parentElement.parentElement.remove()">âœ•</button>
                        </div>
                    `;
                    
                    container.appendChild(titleDiv);
                });
            }

            function useTitle(button) {
                const titleInput = button.parentElement.parentElement.querySelector('input');
                const title = titleInput.value.trim();
                
                if (title) {
                    if (window.App && window.App.setTitleFromCoverScanner) {
                        window.App.setTitleFromCoverScanner(title);
                    }
                } else {
                    showCoverStatus('Please enter a title', 'error');
                }
            }

            function addNewTitle() {
                const container = document.getElementById('titlesContainer');
                const titleDiv = document.createElement('div');
                titleDiv.className = 'title-item';
                
                titleDiv.innerHTML = `
                    <input type="text" value="" placeholder="Movie title">
                    <div class="title-actions">
                        <button class="use-btn" onclick="CoverScanner.useTitle(this)">Use</button>
                        <button class="remove-btn" onclick="this.parentElement.parentElement.remove()">âœ•</button>
                    </div>
                `;
                
                container.appendChild(titleDiv);
            }

            function showList() {
                const inputs = document.querySelectorAll('#titlesContainer input[type="text"]');
                const titles = Array.from(inputs)
                    .map(input => input.value.trim())
                    .filter(title => title.length > 0);
                
                if (titles.length === 0) {
                    showCoverStatus('No titles to show', 'error');
                    return;
                }
                
                const text = titles.join('\n');
                document.getElementById('outputArea').value = text;
                document.getElementById('outputArea').style.display = 'block';
                document.getElementById('outputArea').scrollIntoView({ behavior: 'smooth' });
            }

            function copyText() {
                const text = document.getElementById('outputArea').value;
                
                if (!text) {
                    showCoverStatus('Nothing to copy!', 'error');
                    return;
                }
                
                navigator.clipboard.writeText(text).then(() => {
                    showCoverStatus('âœ… Copied to clipboard!', 'success');
                }).catch(() => {
                    document.getElementById('outputArea').select();
                    document.execCommand('copy');
                    showCoverStatus('âœ… Copied to clipboard!', 'success');
                });
            }

            function showCoverStatus(message, type) {
                const status = document.getElementById('coverStatus');
                status.textContent = message;
                status.className = `status ${type} show`;
                status.style.display = 'block';
                
                setTimeout(() => {
                    status.classList.remove('show');
                    status.style.display = 'none';
                }, 5000);
            }

            return {
                init,
                startCamera,
                stopCamera,
                captureImage,
                clearImages,
                testAPI,
                analyzeImages,
                useTitle,
                addNewTitle,
                showList,
                copyText
            };
        })();

        // Barcode Scanner Integration for CineShelf
        window.BarcodeScanner = (function() {
            let isScanning = false;

            function init() {
                document.getElementById('scanUpcBtn').addEventListener('click', open);
                
                document.getElementById('scannerModal').addEventListener('click', function(e) {
                    if (e.target === this) {
                        close();
                    }
                });
            }

            function open() {
                const modal = document.getElementById('scannerModal');
                modal.classList.add('active');
                startCamera();
            }

            function close() {
                const modal = document.getElementById('scannerModal');
                modal.classList.remove('active');
                stopCamera();
            }

            async function startCamera() {
                if (isScanning) return;

                try {
                    const scanner = document.getElementById('barcodeScanner');
                    const overlay = document.getElementById('scannerOverlay');
                    const placeholder = document.getElementById('scannerPlaceholder');

                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    
                    if (videoDevices.length === 0) {
                        alert('No camera found on this device');
                        return;
                    }

                    const config = {
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: scanner,
                            constraints: {
                                width: { min: 480 },
                                height: { min: 320 },
                                facingMode: "environment"
                            }
                        },
                        decoder: {
                            readers: [
                                "ean_reader",
                                "ean_8_reader",
                                "code_128_reader",
                                "code_39_reader",
                                "upc_reader",
                                "upc_e_reader"
                            ]
                        },
                        locate: true,
                        locator: {
                            patchSize: "medium",
                            halfSample: true
                        },
                        numOfWorkers: 2,
                        frequency: 10,
                        debug: false
                    };

                    await new Promise((resolve, reject) => {
                        Quagga.init(config, (err) => {
                            if (err) {
                                reject(err);
                            } else {
                                resolve();
                            }
                        });
                    });

                    Quagga.onDetected((result) => {
                        const code = result.codeResult.code;
                        if (code && code.length >= 8) {
                            onBarcodeDetected(code);
                        }
                    });

                    Quagga.start();
                    isScanning = true;
                    
                    overlay.style.display = 'block';
                    placeholder.style.display = 'none';

                } catch (error) {
                    console.error('Camera error:', error);
                    alert(`Camera error: ${error.message}`);
                    close();
                }
            }

            function stopCamera() {
                if (isScanning) {
                    Quagga.stop();
                    isScanning = false;
                }

                const overlay = document.getElementById('scannerOverlay');
                const placeholder = document.getElementById('scannerPlaceholder');
                
                overlay.style.display = 'none';
                placeholder.style.display = 'block';
            }

            function onBarcodeDetected(code) {
                document.getElementById('upc').value = code;
                
                playBeep();
                
                if (navigator.vibrate) {
                    navigator.vibrate(100);
                }
                
                if (window.App && window.App.showStatus) {
                    window.App.showStatus(`Barcode scanned: ${code}`, 'success');
                }
                
                setTimeout(() => {
                    close();
                }, 500);
            }

            function playBeep() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                    
                } catch (error) {
                    console.log('Audio not supported:', error);
                }
            }

            return {
                init,
                open,
                close
            };
        })();

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,Y29uc3QgQ0FDSEVfTkFNRSA9ICdjaW5lc2hlbGYtdjEnOwpjb25zdCB1cmxzVG9DYWNoZSA9IFsnLi8nXTsKCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignaW5zdGFsbCcsIGV2ZW50ID0+IHsKICBldmVudC53YWl0VW50aWwoY2FjaGVzLm9wZW4oQ0FDSEVfTkFNRSkudGhlbihjYWNoZSA9PiBjYWNoZS5hZGRBbGwodXJsc1RvQ2FjaGUpKSk7Cn0pOwoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIGV2ZW50ID0+IHsKICBldmVudC5yZXNwb25kV2l0aChjYWNoZXMubWF0Y2goZXZlbnQucmVxdWVzdCkudGhlbihyZXNwb25zZSA9PiByZXNwb25zZSB8fCBmZXRjaChldmVudC5yZXF1ZXN0KSkpOwp9KTs=')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed'));
        }

        // Initialize all apps when page loads
        document.addEventListener('DOMContentLoaded', function() {
            App.init();
            CoverScanner.init();
            setTimeout(BarcodeScanner.init, 100);
        });
    </script>
</body>
</html>